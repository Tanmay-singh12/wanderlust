<% layout("/layouts/boilerplate") %>

<script>
  const mapToken = '<%= process.env.MAP_TOKEN %>';
  const listing = <%- JSON.stringify(listing) %>;
</script>

<style>
  .show-wrapper{
    max-width: 900px;
    margin: 20px auto;
  }

  .show-card img{
    height: 420px;
    object-fit: cover;
    border-radius: 14px;
  }

  .show-card{
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  }

  .owner{
    font-style: italic;
    opacity: .8;
  }

  .action-btns{
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .review-box{
    border-radius: 12px;
    padding: 1.2rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  }

  .review-card{
    border-radius: 10px;
  }

  @media(max-width:768px){
    .show-card img{
      height:260px;
    }
    .action-btns{
      flex-direction: column;
    }
  }
</style>


<div class="container show-wrapper">

  <!-- TITLE -->
  <h3 class="mb-3">
    <%= listing.title %>
  </h3>


  <!-- MAIN CARD -->
  <div class="card show-card mb-4">

    <img src="<%= listing.image.url %>" class="card-img-top" alt="listing image">

    <div class="card-body">

      <p class="owner">
        Owned by <b>@<%= listing.owner.username %></b>
      </p>

      <p><%= listing.description %></p>

      <p class="fw-semibold">
        ₹ <%= listing.price ? listing.price.toLocaleString("en-IN") : "N/A" %> / night
      </p>

      <p><%= listing.location %>, <%= listing.country %></p>


      <% if(currUser && listing.owner._id.equals(currUser._id)) { %>

        <div class="action-btns">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
            Edit
          </a>

          <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE">
            <button class="btn btn-outline-dark">
              Delete
            </button>
          </form>
        </div>

      <% } %>

    </div>
  </div>




  <!-- REVIEW FORM -->
  <% if(currUser) { %>

    <div class="review-box mb-4">

      <h4 class="mb-2">Leave a Review</h4>
      <hr>

      <form action="/listings/<%= listing.id %>/reviews" method="POST" class="needs-validation" novalidate>

        <label class="form-label">Rating</label>
        <fieldset class="starability-slot mb-3">
          <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked />
          <input type="radio" id="first-rate1" name="review[rating]" value="1" />
          <label for="first-rate1" title="1 star">1 star</label>
          <input type="radio" id="first-rate2" name="review[rating]" value="2" />
          <label for="first-rate2" title="2 stars">2 stars</label>
          <input type="radio" id="first-rate3" name="review[rating]" value="3" />
          <label for="first-rate3" title="3 stars">3 stars</label>
          <input type="radio" id="first-rate4" name="review[rating]" value="4" />
          <label for="first-rate4" title="4 stars">4 stars</label>
          <input type="radio" id="first-rate5" name="review[rating]" value="5" />
          <label for="first-rate5" title="5 stars">5 stars</label>
        </fieldset>

        <label class="form-label">Comment</label>
        <textarea name="review[comment]" class="form-control mb-3" rows="3" required></textarea>

        <button class="btn btn-outline-dark">Submit</button>
      </form>
    </div>

  <% } %>




  <!-- EXISTING REVIEWS -->
  <% if(listing.reviews.length>0) { %>

    <h5>All Reviews</h5>
    <div class="row">

      <% for(let review of listing.reviews) { %>

        <div class="col-md-6">
          <div class="card review-card mb-3">
            <div class="card-body">

              <h6>@<%= review.author.username %></h6>

              <p class="starability-result" data-rating="<%= review.rating %>"></p>

              <p><%= review.comment %></p>

              <form
                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                method="POST">
                <button class="btn btn-dark btn-sm">Delete Review</button>
              </form>

            </div>
          </div>
        </div>

      <% } %>

    </div>

  <% } %>




  <!-- MAP -->
  <div class="mt-4">
    <h4>Where you’ll be</h4>
    <div id="map" style="width:100%;height:400px;border-radius:14px;"></div>
  </div>

</div>

<script src="/js/map.js"></script>
